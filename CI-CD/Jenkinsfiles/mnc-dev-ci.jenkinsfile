#!/usr/bin/env groovy

def setJobProperties() {
  properties([
    [
      $class: 'BuildDiscarderProperty',
      strategy: [
        $class: 'BuildRotator',
        daysToKeep: 5,
        numToKeep: 10,
        artifactsDaysToKeep: 5,
        artifactsNumToKeep: 10
      ]
    ]
  ])
}

pipeline {
    agent {
        node {
            label 'master'
        }
    }
    stages {
        stage ('Build environment') {
            steps {
                script {
                    ansiColor('xterm') {
                        withPythonEnv('python') {
                            int exitCode = 0
                            try {
                                stage ('Code style linting') {
                                    echo "\u001B[34m\u001B[1mCode Style Linting\u001B[0m"
                                    try {
                                        sh '''
                                            #!/bin/bash
                                            set -e
                                            python3 -m pycodestyle --ignore=E501 */*.py
                                        '''
                                        println "\u001B[32mCode adheres to PyCodeStyle\u001B[0m"
                                    } catch (Exception e) {
                                        println "\u001B[31mCode style linting failed. Please fix the issues\u001B[0m"
                                        exitCode = 1
                                    }
                                }
                                stage ('Python linting') {
                                    echo "\u001B[34m\u001B[1mPython linting\u001B[0m"
                                    try {
                                        sh '''
                                            #!/bin/bash
                                            set -e
                                            python3 -m pylint --disable=line-too-long --disable=too-many-arguments --disable=unused-argument --disable=too-many-locals --output-format=colorized */*.py
                                        '''
                                        println "\u001B[32mCode adheres to PyLint\u001B[0m"
                                    } catch (Exception e) {
                                        println "\u001B[31mPython linting warning. Please fix the issues\u001B[0m"
                                        exitCode = 1
                                    }
                                }
                                stage ('Pytest and Code coverage') {
                                    try {
                                        sh '''
                                            #!/bin/bash
                                            RULE_FOLDERS=`ls -l -ICI-CD -Icommon -Inotifiers -Itests | grep ^d | awk '{ print $9 }'`
                                            TOTAL_RULES=`ls -l -ICI-CD -Icommon -Inotifiers -Itests | grep ^d | awk '{ print $9 }' | wc -l`
                                            TOTAL_COVERAGE=0
                                            for RULE_FOLDER in $RULE_FOLDERS
                                            do
                                                python3 -m coverage run --source=$RULE_FOLDER/ -m pytest -s tests/$RULE_FOLDER/ || true
                                                COVERAGE=`coverage report -m | tail -1 | awk '{ print $4 }' | sed 's/%//'`
                                                echo "$COVERAGE"
                                                TOTAL_COVERAGE=`expr $TOTAL_COVERAGE + $COVERAGE`
                                            done
                                            AVERAGE_TOTAL_COVERAGE=`expr $TOTAL_COVERAGE / $TOTAL_RULES`
                                            echo "The total average coverage for all the rules: $AVERAGE_TOTAL_COVERAGE%"

                                            if [ "$AVERAGE_TOTAL_COVERAGE" -ge 90 ]; then
                                                zip -r rean-mnc-rule-processor-$GIT_COMMIT.zip . -x ".git/*"
                                                aws s3 cp rean-mnc-rule-processor-$GIT_COMMIT.zip s3://svc-rean-product-default-platform-artifacts/rean-mnc/dev/rean-mnc-rule-processor-$GIT_COMMIT.zip
                                            else
                                                echo 'Coverage is not greater than or equal to 90%. Failed to upload the artifacts'
                                                exit 1
                                            fi
                                        '''
                                        println "\u001B[32mCode coverage ran successfully\u001B[0m"
                                    } catch (Exception e) {
                                        println "\u001B[31mCode Coverage and pytests failed.\u001B[0m"
                                        exitCode = 1
                                    }
                                }
                                sh "exit $exitCode"
                            } catch (Exception e) {
                                println "\u001B[31m\u001B[1mERROR: Continuous Integration PR pipeline failed\u001B[0m"
                                currentBuild.result = 'FAILURE'
                            }
                        }
                    }
                }
            }
        }
    }
    post {
        always {
            deleteDir()
        }
    }
}